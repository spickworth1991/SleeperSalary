<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cap Room Simulator – {{ team_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/static/style.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h2>{{ team_name }} – Cap Room Simulator</h2>
    |<a href="{{ url_for('league_totals', league_name=league_name) }}">⬅ Back to League Totals---</a> |
    <a href="{{ url_for('team_detail', league_name=league_name, user_id=user_id) }}">---Back To Team Detail→</a> |
    {% if session.get('is_admin') and session.get('league_name') %}
        <a href="{{ url_for('admin_page', league_name=session['league_name']) }}">⚙️ Admin Settings</a> |
    {% endif %}

    <p class="text-muted">* Unmatched players are assigned a default cap hit of $5,000,000.</p>

    <h4>Total Cap: <span id="totalCap">{{ total_cap }}</span></h4>
    <button onclick="resetAll()" class="btn">Reset All</button>

    <div class="simulator-flex">
  <div class="simulator-left">
    <table class="responsive-table" id="playerTableWrapper">
      <thead>
        <tr>
          <th>Name</th>
          <th>Team</th>
          <th>Pos</th>
          <th>Age</th>
          <th>Cap Hit</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="playerTable">
        {% for player in players %}
        <tr>
          <td>{{ player.Player }}</td>
          <td>{{ player.Team }}</td>
          <td>{{ player.Pos }}</td>
          <td>{{ player.Age }}</td>
          <td data-num="{{ player.Cap_Hit|replace('$','')|replace(',','')|float }}">{{ player.Cap_Hit }}</td>
          <td><button class="icon-button remove" onclick="removePlayer(this)">❌</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
  </div>

  <div class="simulator-column">
    <h5>Add Players</h5>
    <input type="text" id="playerSearch" placeholder="Type a player name..." />
    <div id="suggestions" class="search-suggestions"></div>
    <label for="teamFilter" class="visually-hidden">Filter by Team</label>
    <select id="teamFilter" onchange="searchPlayer()"><option value="">Filter by Team</option></select>
    <label for="posFilter" class="visually-hidden">Filter by Position</label>
    <select id="posFilter" onchange="searchPlayer()"><option value="">Filter by Position</option></select>
    <button onclick="searchPlayer()" class="btn mt-2">Add Player</button>

    <h4>Removed Players</h4>
    <table class="responsive-table removed-table">
        <thead>
            <tr>
            <th>Name</th>
            <th>Pos</th>
            <th>Cap Hit</th>
            <th></th>
            </tr>
        </thead>
        <tbody id="removedList"></tbody>
    </table>

  </div>
</div>

  <script>
    let totalCap = parseFloat("{{ total_cap|replace('$','')|replace(',','') }}");
    const playerDB = {{ sleeper_data | tojson }};
    const existingIDs = new Set({{ player_ids | tojson }});

    // Build name → list of players map
    const idMap = {};
    for (const [id, data] of Object.entries(playerDB)) {
        const name = data.full_name;
        if (typeof name === "string" && name.trim() && !existingIDs.has(id)) {
            if (!idMap[name]) idMap[name] = [];
            idMap[name].push({ id, ...data });
        }
    }

    function updateCapDisplay() {
        document.getElementById("totalCap").textContent = "$" + totalCap.toLocaleString();
    }

    function removePlayer(button) {
        const row = button.closest('tr');
        const cap = parseFloat(row.children[4].dataset.num) || 0;
        totalCap -= cap;
        updateCapDisplay();

        const rowHTML = row.outerHTML;
        const name = row.children[0].innerText;
        const pos = row.children[2].innerText;

        const isFromOriginalRoster = !row.querySelector('.remove').innerText.includes('*');
        row.remove();
        updateCapDisplay();

        // Only add to removed list if original
        if (isFromOriginalRoster) {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${name}</td>
                <td>${pos}</td>
                <td>${formatMoney(cap)}</td>
                <td><button class="icon-button add" onclick='addBackRow(this, \`${rowHTML}\`)'>➕</button></td>
            `;
            document.getElementById("removedList").appendChild(row);
        }

    }

    function formatMoney(value) {
        return "$" + Number(value).toLocaleString();
        }


    function addBackRow(button, rowHTML) {
        const table = document.getElementById("playerTable");
        const temp = document.createElement('tbody');
        temp.innerHTML = rowHTML;
        const restoredRow = temp.firstChild;

        const cap = parseFloat(restoredRow.children[4].dataset.num) || 0;
        totalCap += cap;
        updateCapDisplay();

        restoredRow.querySelector('.remove').onclick = function() {
            removePlayer(this);
        };

        table.appendChild(restoredRow);
        button.closest('tr').remove();
        sortTableByCap();
    }

    function searchPlayer() {
        const input = document.getElementById("playerSearch").value.trim().toLowerCase();
        const selectedTeam = document.getElementById("teamFilter").value;
        const selectedPos = document.getElementById("posFilter").value;
        const suggestionsBox = document.getElementById("suggestions");
        suggestionsBox.innerHTML = "";

        if (!input) return;

        const matches = Object.entries(idMap).filter(([name, players]) => {
            const nameMatch = name.toLowerCase().includes(input);
            const teamMatch = (player) => !selectedTeam || player.team === selectedTeam;
            const posMatch = (player) => !selectedPos || player.position === selectedPos;

            // At least one matching player in this group must match all filters
            return nameMatch && players.some(player => teamMatch(player) && posMatch(player));
        });

        if (matches.length === 0) {
            suggestionsBox.innerHTML = `<p>No matches found.</p>`;
            return;
        }

        const allPlayers = matches.flatMap(([_, players]) =>
            players.filter(player =>
                (!selectedTeam || player.team === selectedTeam) &&
                (!selectedPos || player.position === selectedPos)
            )
        );

        if (allPlayers.length === 1) {
            addPlayerToList(allPlayers[0]);
            document.getElementById("playerSearch").value = "";
            return;
        }

        // Multiple matches — show options
        suggestionsBox.innerHTML = `<p>Select a player:</p>`;
        const list = document.createElement("ul");
        list.className = "search-results";
        allPlayers.forEach(player => {
            const li = document.createElement("li");
            const btn = document.createElement("button");
            btn.className = "btn btn-link";
            btn.innerHTML = `
                <strong>${player.full_name}</strong> – ${player.team || "No Team"}<br>
                <small>${player.position}, Age ${player.age}</small>
                <small>${player.cap_str || "$5,000,000"}</small>
            `;
            btn.onclick = () => {
                addPlayerToList(player);
                document.getElementById("playerSearch").value = "";
                document.getElementById("suggestions").innerHTML = "";
            };
            li.appendChild(btn);
            list.appendChild(li);
        });
        suggestionsBox.appendChild(list);
    }


    function addPlayerToList(data) {
        const cap = data.cap_num || 5000000;
        const capStr = data.cap_str || "$5,000,000";
        totalCap += cap;
        updateCapDisplay();

        const table = document.getElementById("playerTable");
        const row = table.insertRow();
        row.innerHTML = `
            <td>${data.full_name}</td>
            <td>${data.team || "No Team"}</td>
            <td>${data.position}</td>
            <td>${data.age}</td>
            <td data-num="${cap}">${capStr}</td>
            <td>
            <button class="icon-button remove" onclick="removePlayer(this)">❌ *</button>
            </td>
        `;

        sortTableByCap();
    }

    function sortTableByCap() {
        const tbody = document.getElementById("playerTable");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        rows.sort((a, b) => {
            const aVal = parseFloat(a.children[4].dataset.num) || 0;
            const bVal = parseFloat(b.children[4].dataset.num) || 0;
            return bVal - aVal;
        });

        rows.forEach(row => tbody.appendChild(row));
    }


    function resetAll() {
        window.location.reload();
    }

    window.onload = function () {
        const teams = new Set(), positions = new Set();
        Object.values(playerDB).forEach(p => {
            if (p.team) teams.add(p.team);
            if (p.position) positions.add(p.position);
        });

        const teamFilter = document.getElementById("teamFilter");
        [...teams].sort().forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            teamFilter.appendChild(opt);
        });

        const posFilter = document.getElementById("posFilter");
        [...positions].sort().forEach(p => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p;
            posFilter.appendChild(opt);
        });

        sortTableByCap();  // initial sort
    };

    </script>
</body>
</html>